# 第一章 计算机和互联网

## 1、什么是互联网？

节点和边的关系，是一张图。

到了计算机网络中，节点包含主机节点、数据交换节点（路由器、交换机等）。数据交换节点不是信息源，也不是信息接收目标。我们使用方形来代表主机节点，为了方便，我记为x，用y表示数据交换节点。

主机节点和数据交换节点等之间的通路，称为**通信链路**。其通信速率用bps衡量，即bit per second。

主机连接到互联网的链路，称为接入网链路。路由器间的链路称为主干链。

协议的概念：共同遵守的标准。在不同层有不同的协议，包括语法、语义、时序、动作。

互联网指以TCP/IP协议为主形成的网络，并且与外界相连。不联通，则为intranet。

通讯的过程中，“对等层的实体”要遵守的规范，称为“协议”。

Internet标准在IETF处以RFC文档形式进行发布。

协议包括人类协议和网络协议。

互联网是分布式的应用进程以及为其通信提供服务的基础设施。

## 2、网络的边缘

网络包括网络的核心、网络的接入、网络的边缘。

网络边缘指的是主机及应用程序。

接入系统是用于把网络的边缘接入网络的核心。

核心系统起数据交换的作用。是一个枢纽。

网络边缘主要有两种模式：客户/服务器模式，以及对等（peer-peer）模式。

在CS模式中，服务器需要先启动，是主；客户端是从。所有的资源都在服务器上。但是，这种模式的可扩展性较差。当访问请求达到一定阈值时，效能断崖式下降。

在p2p模式中，每个节点，在某些会话中，可以作为客户端；在某些过程中，又可以作为服务端。

网络边缘：采用面向连接的通信服务，指的是通信状态只在端系统上可以获知。

可靠性：不重复，不丢失，不出错，不失序。

TCP会保证可靠性，也会进行流量控制，保证包发送速度在端节点合适；也会进行拥塞控制，保证包发送速度在链路上的中转节点合适。

UDP则无连接，不可靠，没有流量控制和拥塞控制。适用于直播等。

## 3、网络核心

一般具有两种方式：电路交换和分组交换。

两个主机使用信令系统申请（会耗费一定的时间）后，可以独享一条链路（线路中的一部分）以供通信。不共享可以保证性能，但是可能会导致资源浪费。就算没有流量，这一条通道持续在被占用。

有一个问题，用什么方式来把带宽资源分成片？有频分、时分、波分（光通信）。频分，指的是把不同的频率分开；时分，指的是划分为一定量的时间片，由于周期不变，对应的数据会给到对应的用户；波分，和频分的操作方式较为类似。

但是电路交换不适合于计算机的通信。因为建立通信需要一定的时间，而且计算机之间的通信具有很强的突发性，会导致较多网络资源的浪费。

而且，若一个核心节点被损毁，影响会很大。

另外一种通信的方式，是分组交换的方式。首先，会将文件分为多个包。在这种方式中，每一个链路上都会暂时占有链路的全部。然后，资料会被存储在交换节点中。之后，再进行下一步转发。这样可以减少对网络资源的浪费。用排队和存储的时间，换取了网络的共享性。

如果到达速率快过了输出的速率，分组将会排队，等待传输。如果**队伍过长**，缓存被填满了，那么分组将会被抛弃。文件可能会被传丢了。

但是，分组交换可以容纳更多的主机进行传输。

路由：决定分组采用的从源到目标的路径。

转发：将分组从路由器的输入链路转发到输出链路。

因此，分组交换适用于强突发性的情况。

数据报、虚电路两种不同的存储转发策略。数据报方式不用在节点上维护通信状态，目标节点都 已存在数据中了；虚电路则需要维护节点处的通信状态，在交流数据之前需要靠信令建立起来，根据虚电路表进行操作。

## 4、接入网和物理媒体

 住宅接入：modem，调制解调器（猫）。

一种方式是利用已有的电话线，用于传输数据。因为电话传输的语音，传输的频率只有4kHz。因此，使用调制解调器，把数据调制为4kHz内。从而进行数据的传输。

一种方式是进行接入网（DSL）。4kHz内用于电话通信。更高的频率，用于上下行的传输数据。

还有一种方式是使用有线电视公司的线，即 线缆网络。

国外还可以使用电网来传输数据。

剩下的还有无线接入网络。

还有企业接入网络。

物理媒介有导引性媒体，以及非导引性媒体。导引性，指的就是有限制的传输媒体。比如同轴电缆、光纤等。非导引性的就是无线的，比如地面微波，LAN，wide-area，卫星等。

## 5、Internet结构和ISP

端系统通过接入ISP来连接到互联网。即Internet Service Providers。

接入ISP之间，应当是互联的。

显然它们不应当直接相连，没有可扩展性。

所以，可以把接入ISP连接到全局的ISP，从而完成数据之间的收发。

全局ISP可以由不同运营商承担。同时，运营商之间也应当连接链路。

可以有对等连接方式，还有IXP(internet exchange point)，作为共同的中转站。

regional ISP就是负责区域网的ISP。

对于Google，Wechat等会在各地部署数据中心，在海底可以拉一根光缆从而传输数据，从而降低成本，并且提高用户的体验。

因此，互联网的中心是第一层的ISP。

第二层的ISP则是区域性的了。

## 6、分组延时、丢失和吞吐量

四种分组延时的方式：

节点处理延时：检查是否出错，并且检查路由表。

排队延时：排队。

传输延时：传输所需的时间和存储转发延时。

传播延时：通过物理介质传播所需的时间。

排队延时取决于流量强度。$I={La\over R}$

L为每个包的数据量，a为每单位时间来到的包总数，R则为单位时间内可以发出的数据量。流量强度应当在0,1之间。

ICMP协议：互联网控制报文协议。

对于信息中，存在IP头，其中存有生存时间（ttl），当时间超过之后，则会向源地址发送一个信息，并且回报自己的ip，并回报“目标地址不可达”。生存时间，没被转发一次，就会减1。

吞吐量：源端和目标端之间数据的传输速率。我们把影响吞吐量的那一条链路，称为“瓶颈链路”。

## 7、协议层次与服务模型

计算机网络通过分层模块的方式。

协议是在本层内的，为了向上层提供更高的服务。每一层可以调用下一层的服务，使用接口进行调用。同层之间的交流，可以为上层提供出新的服务。该层对上层的服务包括**以下层的服务之总和**，以及同层间通过交互所形成的新的功能。

不过物理层就没有下一层辣。

服务访问点（SAP）：用于下层的服务提供者来区分上层的用户，即用于标识。

原语：用于层间的交流，说明调用的功能等。

服务的类型分为面向连接的服务，以及无连接的服务。面向连接，即指使用下层提供的服务之前，必须要在上层之间建立连接，如TCP。反之，则是无连接的服务，如UDP。

数据单元(DU)：

上层要求传输到下层的主要内容是SDU(Serivice data unit)。为了便于控制，还会添加一部分header。这两部分共同组成了PDU。如此从上层至下层，层层相叠，便构成了该层总的PDU。

Internet的协议栈为：应用层、传输层、网络层、链路层、物理层。

物理层：把数字数据转化为物理信号使之传输。

链路层：在相邻两点间传输以帧为单位的数据。

网络层：解决从源到目标节点的传输。转发和路由两种重要的功能就在这里。

传输层：解决进程之间的区分问题。同时会将下层的不可靠服务转化为可靠的服务。

ISO/OSI将前面修改为了：应用层、表示层、会话层、传输层、...

表示层用于解释传输的数据，比如加密、压缩等。会话层则是为了进行数据交换的同步，检查点，以及恢复。在Internet协议栈中，这两部分都被归在了应用层中。

# 第二章 应用层

## 1、应用层原理

C/S模式、P2P模式，混合体模式。

进程之间的通信：在同一主机上，使用自身的OS即可。如果在不同主机间，则是通过交换报文的方式来进行通信。客户端进程，指的是发出请求的进程。服务器进程，指的是等待连接的进程。 

分布式进程通信需要解决的问题：标识自身和对象，下一层如何提供服务，如何使用下一层的服务。 

端口号用于区分不同的进程。 层间接口必须要将数据本身、传输数据的源地址，对方的应用进程标识进行传输。

如何简化这一个过程？就是使用socket方法。当建立了通信关系以后，直接用一个整数代表一个通信的过程，（TCP）即源IP、port和目标IP和port。 同时，会记录这个通信的状态。如果是UDP，显然就应该只有两个内容，即本机IP和port。但是在传输的时候，UDP也需要指明接受的对象。

应用层协议：定义了应用进程之间如何相互传输报文。常见的，比如说有HTTP协议等。协议也分为公开协议和专有协议。

我们需要传输层需要向上层提高这些方面的性能：数据丢失率、延迟、吞吐、安全性。

TCP：可靠、流量控制、拥塞控制、 面向连接。

UDP是不可靠的。但是，他比IP好的地方在于，他可以直接将数据传到对应的进程。同时，牺牲了可靠性，可以加速很多。

TCP是没有进行加密的。进行加密的是SSL。应用层在使用SSL的基础上使用TCP，那么就可以进行安全的传输服务。SSL在应用层中。

## 2、Web与HTTP

Web页由一些对象组成。一般含有一个基本的HTML文件以及其他的内容。一般而言，通过URL对页面上的不同内容进行引用。

URL格式：协议名、用户：口令、主机名、路径名、端口。

HTTP协议：超文本传输协议。首先，建立TCP连接，然后客户端浏览器进行HTTP请求，然后服务器将所请求的内容以HTTP格式重新发回来。端口号为80。在通话中，会产生一个waiting的socket（80端口），还有真正建立连接的socket（80端口）。HTTP协议中，服务端不会维护客户的信息。

往返时间（RTT）：小分组从客户端到服务器，再回到客户端的时间。

持久HTTP包含非流水线式和流水线式两种不同的类型。流水线型，就是在同一时刻会进行较多的并发。（也就是客户端同时间内发较多的请求）

两种类型的HTTP报文：请求与响应。

请求报文使用的ASCII码。包含首部行：请求行（GET、POST、HEAD等类型、URL、版本）、域名、用户代理、连接方式、接受的语言。然后在最后还要空行。之后，还会有可能存在的请求体等。

提交表单方式，一般有POST和URL这两种方式。POST将表单放在请求的实体当中，而URL则是向上级提供了一个URL链接，这是GET方式的。

响应报文，包含首部行和数据。首部行第一行是状态行，包括协议、状态码、需要读取的内容长度等内容。常见的状态码有200、301、400、404、505等。

要想维护服务器和客户端之间的连接，可以使用cookie。第一次访问中，由于之前没有访问过，所以没有cookie。在交互之后，就可以产生出cookie，帮助服务端维护用户的信息。但问题是，cookie可能存在隐私问题。

Web缓存（代理服务器）：目标是不访问原始服务器，就满足客户的请求。对客户端而言，可能会更快，同时网络和服务器的负担会下降。

本地访问：进行本地的缓存。

## 3、FTP

文件传输协议。可以通过该协议将文件上传至服务器，也可以将服务器的文件下载至主机。服务器在21号端口守护进程。

FTP用于维护状态并通信，建立一个TCP连接。FTP通信建立之后，服务器会建立第二个TCP连接。客户端主动建立的，用于传输控制命令。服务器主动建立的TCP，用于传输数据。

## 4、Email

3个组成部分：用户代理、邮件服务器、简单邮件传输协议（SMTP）。

邮件服务器就是用于发送寄信人的邮件，发走收信人的邮件到其邮箱中。 

客户端->邮件服务器->邮件服务器->客户端。

邮件服务器的发送进程守护在25号端口，也是使用TCP协议进行传输。

SMTP的命令响应报文也都使用ASCII形式。报文必须是7位ASCII码。 

SMTP使用的是持久连接。要求报文使用7位ASCII码。SMTP使用的是“推”的思路。

MIME：多媒体邮件扩展。  

POP：邮局访问协议。在代理和服务器之间使用。用于身份的确认。

IMAP：Internet邮件访问协议。能够使用户远程访问邮件。

## 5、DNS

 Domain Name System

用于标识以及寻址。问题在于IP地址并不好记忆。

DNS需要解决重名问题，所以要进行分层化的命名。

DNS需要解析域名，仅用一台机器来维护，显然是不合适的，所以要采取分布式的方式。

DNS需要解决增加和删除域名的问题。

DNS是分层的域名，由分布式的数据库解决域名解决的问题。DNS运行在53号端口，UDP协议。其最主要的目的是将主机名和IP地址之间实现转换。此外，还有将规范名和别名的转换。

Internet根被划分为几百个顶级域名。有通用域名和国家域名。每个域名下面又可以分配若干个域名。

DNS总共有13个根服务器。

域与物理分布无关，仅与社会关系有关。 

使用分布式解决方案，将域名划分为不同的区域。每个区域都有一个名字服务器，维护着管理区域的权威信息。

顶级域服务器(TDL)：负责顶级域名和所有国家级的顶级域名。

每个区域的名字服务器维护资源记录，用于维护域名和IP地址之间的映射，位于名字服务器的额分布式数据库中。RR格式：包括域名、生存时间、类别、值、类型。其他地方获取的则是缓存的域名，因此有生存时间；在名字服务器中，是权威性的，生存时间是无限长。value中，存储的即是IP地址等。对于网站，class的值一直是in。

Type若为A，则name放的是主机，value放的是IP；cname，则放的是别名，value为规范名字；ns，则说明放的是一个子域的名字，value放的是子域的权威服务器的名字；MX，放的是邮箱服务器。

DNS的工作流程：调用解析器，解析器向name server发送查询报文，name server再返回。

本地名字服务器：任何名字服务器都可以。但一般都会选择同一子网内的。（因为快）

DNS过程中，有递归查询和迭代查询两种方式。

DNS协议：查询和响应报文1相同。内容包含ID号，

名字服务器查询过某域名后，会将其缓存，一般生存时间是2d。

如果要新增域名，需要向上级服务器中增加两条记录，指向这个新增的子域的域名和域名服务器的地址。

## 6、P2P应用

P2P分为两类。非结构化P2P和DHT（结构化）P2P。

非结构化P2P：peer之间的关系是任意的；结构化P2P：peer之间的关系能够建立出环、树之类的结构。

非结构化P2P的方式

第一种：采用集中式目录。每个用户使用时，必须向目录服务器注册。告知服务器自身的IP地址和资源。这种方式存在的问题是，如果单点发生故障，或者用户数量过多，服务器可能负载过大。同时，可能也存在版权问题。

第二种，采取完全分布式。会下载IP的总目录表。然后，会向所有的目录上的节点发出ping。同样的，退出的时候也类似。所有客户会向所有的邻居发出查询。之后，其会像邻居进一步查询。拥有该节点的对象会给出应答。这被称为泛洪查询。泛洪查询中可能会产生死递归。可以引入生存时间、或者打标记，说明已经询问过了的方式来避免之。

第三种，混合式。每个节点要么是组长，要么隶属于一个组长。所有组员会向组长发出查询。组长会检查组内是否有该内容。如果没有，再向其他组长发出信息。在组长处，文件也是采用hash值的方式进行查询。

在使用过程中，会将文件进行分块，从而提高效率。

在分发的时候，可以在前两次分发中，给那些传给自己内容较多的节点优先权。之后随机。

结构化的P2P，维护着树状或环状的语序结构。每个节点用自己IP的hash值作为唯一的标识。比如环状，就是按hash值的大小首尾相接地构成一个环状。

## 7、CDN

DASH：多媒体流化服务。服务器将文件分为多个块。

客户端则先获取告示文件，根据当前缓冲区大小、网络带宽以及服务器情况等，动态地选择获取的内容，比如不同清晰度的对象。

CDN：Content Distribution Networks

全网部署多个缓存节点，存储服务器的内容，就近为用户提供服务。一种策略是更接近底层，到local ISP，从而跳转更少。一种是在少数关键位置，比如ISP附近。

## 8、TCP Socket

应用进程通过传输层提供的服务进行接受报文。提供的服务指的是Socket API。

TCP：可靠的、字节流的服务。UDP：不可靠的。

首先，服务器进程运行。然后，创建欢迎socket，将整数与IP等信息捆绑。并在欢迎socket进行等待。然后，客户端本地创建一个Socket，与本地的port捆绑。 之后，指定服务器进程的IP地址和端口号，与服务器进程连接。当客户端连接请求到来时，欢迎socket会返回一个**新的**connection socket。其与客户端和自身的IP、port相捆绑。原来的欢迎socket依旧守候在原端口。

1. Welcome Socket建立

2. Welcome Socket与服务器IP和端口捆绑

3. 接受客户端的请求，创建Connection Socket并阻塞

4. 在客户端创建Socket

5. 隐式的与客户端IP及端口捆绑

6. 向服务器发出一个请求。

7. 服务端Connection Socket解除阻塞。并从客户端创建的socket应答。

8. 客户端发出一个send请求。发出本地创建的socket和要求传输的内容。

9. 服务器调用read函数，对请求进行处理。

10. 使用write函数返回内容。

## 9、UDP Socket

Socket只包含本地的IP和UDP端口。发送过程中必须显式指出接收对象的IP和端口。

1. 服务端建立Socket

2. 与服务端IP、端口号进行捆绑

3. 客户端发出请求

4. 服务器read函数接受请求

5. 客户端创建一个Socket，与自身IP、端口绑定

6. 客户端发出一个send请求。将客户端创建的socket发出。

7. 服务端对接受的内容进行处理，将内容发出

8. 客户端接受信息，之后关闭

# 第三章 传输层

网络层，负责的是主机之间的逻辑通信。

传输层，负责的是进程之间的逻辑通信。

## 1、多路复用和解复用

多路复用和多路分解（解复用）不知道是哪个天才想出来的名词，逆天程度堪比套接字和鲁棒性，一点也不容易理解...

多路复用，指的是给不同socket的数据封装上首部信息，生成报文段。

运输层将信息传输给接收方后，接收方根据这些首部信息将报文定向到目标的socket。

这种翻译一点也做不到“达”的要求......

## 2、UDP：User Datagram Protocol

UDP不建立连接，所以快。

报文段的头部也很小，仅包括8Byte。包含：源端口号、目的端口号、长度、校验和。
